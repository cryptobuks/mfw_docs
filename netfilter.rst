Netfilter
=========

Below reference information for the inner workings of netfilter within MicroFirewall.


Flow
----

.. image:: images/mfw-flow.png
    :scale: 40%

Tables
------

access
~~~~~~~~~~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The filter rules holds basic access rules for filtering traffic to the router               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | user                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | inet                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | table_manager in sync-settings                                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| access-rules                              | true     | inet       | filter   | input      | 0             |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined with suggested defaults                       |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

captive-portal
~~~~~~~~~~~~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The captive-portal tables holds captive-portaling related chains                            |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | user                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | ip,ip6                                                                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | table_manager in sync-settings                                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| captive-portal-rules                      | true     | ip         | nat      | prerouting | -110          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined captive portal rules                          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| captive-portal-rules                      | true     | ip6        | nat      | prerouting | -110          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined captive portal rules                          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

filter
~~~~~~~~~~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The filter rules holds basic filtering rules                                                |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | user                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | inet                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | table_manager in sync-settings                                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| filter-rules                              | true     | inet       | filter   | forward    | 0             |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | calls filter-rules-new on new sessions                      |
|                                           | | calls filter-rules-early on early sessions                  |
|                                           | | calls filter-rules-all on all packets                       |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| filter-rules-new                          | false    | inet                                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined                                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| filter-rules-early                        | false    | inet                                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined                                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| filter-rules-all                          | false    | inet                                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined                                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

interface-marks
~~~~~~~~~~~~~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The interface-marks table holds all chains related to managing interface marks & connmarks  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | system                                                                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | inet                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | interface_manager in sync-settings                                                          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               prerouting-interface-marks  | true     | inet       | filter   | prerouting | -150          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | sets src interface marks for new sessions                   |
|                                           | | restores src and dst marks for others                       |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               forward-interface-marks     | true     | inet       | filter   | forward    | -150          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | sets the dst interface mark after routing on new sessions   |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               postrouting-interface-marks | true     | inet       | filter   | postrouting| 0             |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | sets the dst interface mark after routing on new sessions   |
|                                           | | restores dst marks for others                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               output-interface-marks      | true     | inet       | filter   | output     | -150          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | sets the src/client mark to 0xff (local)                    |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               input-interface-marks       | true     | inet       | filter   | input      | -150          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | sets the dst/server mark to 0xff (local)                    |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

nat
~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The nat table holds the user defined nat rules                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | user                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | ip,ip6                                                                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | table_manager in sync-settings                                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                nat-rules                  | true     | ip,ip6     | nat      | postrouting| 95            |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | user defined nat rules                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

nat-sys
~~~~~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The nat table holds all the nat-related chains                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | system                                                                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | ip,ip6,inet                                                                                 |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | nat_manager in sync-settings                                                                |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                prerouting-nat             | true     | ip         | nat      | prerouting | -50           |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | ip prerouting-nat calls miniupnpd                           |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                prerouting-nat             | true     | ip6        | nat      | prerouting | -50           |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | ip6 prerouting-nat currently does nothing                   |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                filter-rules-nat           | true     | inet       | filter   | forward    | -5            |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | filter-rules-nat stops sessions to NATd interfaces unless   |
|                                           | | they have been explicitly port forwarded (DNATd)            |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                postrouting-nat            | true     | ip         | nat      | postrouting| 100           |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | ip poustrouting-nat calls nat-rules-sys                     |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                postrouting-nat            | true     | ip6        | nat      | postrouting| 100           |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | ip6 poustrouting-nat currently does nothing                 |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                miniupnpd                  | false    | ip                                                 |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | miniupnpd chain is managed my miniupnpd                     |
|                                           | | miniupnpd inserts dnat rules based on UPnP                  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                nat-rules-sys              | false    | ip                                                 |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | nat-rules-sys holds the SNAT rules based on interface       |
|                                           | | configuration. (natEgress and natIngress settings)          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

packetd
~~~~~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The packetd tables holds all packetd related chains                                         |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | system                                                                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | inet                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | packetd daemon                                                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               prerouting-packetd          | true     | inet       | filter   | prerouting | -140          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | queues any non-bypassed traffic to packetd                  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               intput-packetd              | true     | inet       | filter   | input      | -150          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | sets bypass on input (local) traffic                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               output-packetd              | true     | inet       | filter   | output     | -145          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | sets bypass on output (local) traffic                       |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

port-forward
~~~~~~~~~~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The port-forward table holds port forwards configured by the admin                          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | user                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | ip,ip6                                                                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | table_manager in sync-settings                                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               port-forward-rules          | true     | ip         | nat      | prerouting | -100          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | holds admin configured port forward rules                   |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               port-forward-rules          | true     | ip6        | nat      | prerouting | -100          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | holds admin configured ip6 port forward rules               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

qos
~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The qos tables holds qos related chains                                                     |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | system                                                                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | inet                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | qos_manager in sync-settings                                                                |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| postrouting-qos                           | true     | inet       | filter   | postrouting| 5             |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | calls restore-priority-mark                                 |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| restore-priority-mark                     | false    | inet                                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | restores the priority mark from connmark                    |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

shaping
~~~~~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The holds the user chains related to bandwidth shaping                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | user                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | inet                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | table_manager in sync-settings                                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               postrouting-shaping-rules   | true     | inet       | filter   | postrouting| 50            |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | calls prioritization-rules                                  |
|                                           | | calls limiting-rules                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               prioritization-rules        | false    | inet                                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined rules to set priority mark                    |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               limiting-rules              | false    | inet                                               |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined rules to set limits                           |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+

web-filter
~~~~~~~~~~

+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| description | The web-filter tables holds web-filtering related chains                                    |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| type        | user                                                                                        |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| families    | ip,ip6                                                                                      |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| manager     | table_manager in sync-settings                                                              |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|               **chain name**              | **base** | **family** | **type** | **hook**   | **priority**  |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| web-filter-rules                          | true     | ip         | nat      | prerouting | -105          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined web filtering rules                           |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
| web-filter-rules                          | true     | ip6        | nat      | prerouting | -105          |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+
|                                           | | admin-defined web filtering rules                           |
+-------------+-------------+---------------+----------+------------+----------+------------+---------------+


Marks
-----

Marks and Connmarks are used heavily to store metadata about a packet or session.
The following tables show how the various bits within the mark or connmark are used.

Mark (packet mark):

========== =============================== ===========
Bitmask    Name                            Description
---------- ------------------------------- -----------
0x000000ff Source Interface Zone           The incoming (source) interface ID (0xff is local)
0x0000ff00 Destination Interface Zone      The outgoing (destination) interface ID (0xff is local)
0x00ff0000 QoS                             TBD (Reserved)
0x03000000 Source Interface type           The incoming (source) type (unset=0, WAN=1, LAN=2, unused=3)
0x0c000000 Destination Interface type      The outgoing (destination) type (unset=0, WAN=1, LAN=2, unused=3)
0x10000000 Conntrack state is NEW          This packet is the first packet of a connection
========== =============================== ===========

Connmark (connection/session mark):

========== =============================== ===========
Bitmask    Name                            Description
---------- ------------------------------- -----------
0x000000ff Client Interface Zone           The client interface ID of this packet (0xff is local)
0x0000ff00 Server Interface Zone           The server interface ID of this packet (0xff is local)
0x00ff0000 QoS                             TBD (Reserved)
0x03000000 Client Interface type           The client interface type (unset=0, WAN=1, LAN=2, unused=3)
0x0c000000 Server Interface type           The server interface type (unset=0, WAN=1, LAN=2, unused=3)
0x80000000 Bypass packetd                  If set all packets in this connection skip the packetd queue
========== =============================== ===========

